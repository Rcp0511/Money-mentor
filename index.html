<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Money Mentor ‚Äì Student Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg: #f3f7f4;
    --card: #ffffff;
    --text: #102015;
    --muted: rgba(0,0,0,0.55);

    --green: #2c8b45;
    --green-dark: #0b3d1a;
    --green-soft: #dff3e5;

    --shadow: 0 18px 45px rgba(0,0,0,0.12);

    --btn: #1f7a3b;
    --btnText: #fff;

    --danger: #d60000;

    --outline: rgba(0,0,0,0.12);

    --overlay: rgba(0,0,0,0.65);
  }

  body.dark{
    --bg: #0b0f0d;
    --card: #121916;
    --text: #e9f5ee;
    --muted: rgba(255,255,255,0.65);

    --green: #2fb35c;
    --green-dark: #0a2a14;
    --green-soft: rgba(47,179,92,0.14);

    --shadow: 0 20px 55px rgba(0,0,0,0.55);

    --btn: #2fb35c;
    --btnText: #07130b;

    --outline: rgba(255,255,255,0.12);

    --overlay: rgba(0,0,0,0.75);
  }

  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family: "Montserrat", system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
  }

  /* ===== Top Bar (with pattern) ===== */
  .topbar{
    position: sticky;
    top: 0;
    z-index: 50;
    background: linear-gradient(135deg, #3bb85d, #1f7a3b);
    padding: 18px 18px;
    color: white;
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    overflow:hidden;
  }

  /* Pattern overlay */
  .topbar::before{
    content:"";
    position:absolute;
    inset:0;
    background:
      radial-gradient(circle at 20% 20%, rgba(255,255,255,0.14) 0 14px, transparent 15px),
      radial-gradient(circle at 70% 40%, rgba(255,255,255,0.12) 0 12px, transparent 13px),
      radial-gradient(circle at 35% 80%, rgba(255,255,255,0.12) 0 18px, transparent 19px),
      linear-gradient(45deg, rgba(255,255,255,0.06) 0 25%, transparent 25% 50%, rgba(255,255,255,0.06) 50% 75%, transparent 75% 100%);
    background-size: 120px 120px, 160px 160px, 190px 190px, 38px 38px;
    opacity: 0.85;
    pointer-events:none;
  }

  .topbar-inner{
    position:relative;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:14px;
    max-width: 1100px;
    margin:0 auto;
  }

  .title{
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .title h1{
    margin:0;
    font-size: 1.15rem;
    letter-spacing: 0.2px;
  }
  .title .sub{
    font-size: 0.85rem;
    opacity: 0.9;
    font-weight:600;
  }

  .top-actions{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }

  .nav-btn{
    border:none;
    padding: 10px 16px;
    border-radius: 14px;
    font-weight: 800;
    cursor:pointer;
    transition: transform 0.12s ease, opacity 0.12s ease;
    user-select:none;
    box-shadow: 0 10px 22px rgba(0,0,0,0.18);
  }
  .nav-btn:active{ transform: scale(0.98); }

  .back-btn{
    background: #0b3d1a;
    color: white;
  }
  .videos-btn{
    background: rgba(255,255,255,0.16);
    color: white;
    border: 1px solid rgba(255,255,255,0.25);
  }

  .mode-btn{
    background: rgba(255,255,255,0.95);
    color: #0b3d1a;
  }
  body.dark .mode-btn{
    background: #111a14;
    color: #e9f5ee;
    border: 1px solid rgba(255,255,255,0.12);
  }

  .units-box{
    display:flex;
    align-items:center;
    gap:10px;
    padding: 10px 14px;
    border-radius: 16px;
    background: rgba(255,255,255,0.18);
    border: 1px solid rgba(255,255,255,0.22);
    font-weight: 800;
    box-shadow: 0 10px 22px rgba(0,0,0,0.15);
    white-space:nowrap;
  }
  .units-box span{
    opacity: 0.95;
    font-size: 0.95rem;
  }
  .units-box .star{
    font-size: 1.05rem;
  }

  /* ===== Main ===== */
  .wrap{
    max-width: 1100px;
    margin: 0 auto;
    padding: 22px 18px 90px;
  }

  .grid{
    display:grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 16px;
  }

  @media(max-width: 980px){
    .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
  }
  @media(max-width: 650px){
    .grid{ grid-template-columns: 1fr; }
  }

  .unit-card{
    background: var(--card);
    border-radius: 22px;
    padding: 18px;
    box-shadow: var(--shadow);
    border: 1px solid var(--outline);
    position:relative;
    overflow:hidden;
  }

  .unit-card::before{
    content:"";
    position:absolute;
    inset:0;
    background: linear-gradient(135deg, rgba(47,179,92,0.12), transparent 55%);
    pointer-events:none;
  }

  .unit-head{
    position:relative;
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
    margin-bottom: 12px;
  }

  .unit-name{
    font-size: 1.05rem;
    font-weight: 900;
    margin:0;
  }
  .unit-desc{
    margin:6px 0 0;
    font-size: 0.85rem;
    opacity: 0.75;
    line-height:1.2;
    font-weight:600;
  }

  .badge{
    position:relative;
    font-weight: 900;
    padding: 7px 10px;
    border-radius: 999px;
    font-size: 0.78rem;
    border: 1px solid var(--outline);
    background: var(--green-soft);
    color: var(--text);
  }

  .score-line{
    position:relative;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-top: 12px;
    font-weight:800;
  }
  .score-line .best{
    opacity: 0.85;
    font-size: 0.9rem;
  }

  .progress{
    margin-top: 12px;
    height: 12px;
    background: rgba(0,0,0,0.08);
    border-radius: 999px;
    overflow:hidden;
    border: 1px solid var(--outline);
    position:relative;
  }
  body.dark .progress{
    background: rgba(255,255,255,0.07);
  }

  .bar{
    height:100%;
    width:0%;
    background: linear-gradient(90deg, #2fb35c, #1f7a3b);
    border-radius: 999px;
    transition: width 0.35s ease;
  }

  /* Dropdown (Study/Test 50/50) */
  .dropdown{
    margin-top: 14px;
    display:flex;
    border-radius: 18px;
    overflow:hidden;
    border: 1px solid var(--outline);
    background: rgba(0,0,0,0.03);
  }
  body.dark .dropdown{
    background: rgba(255,255,255,0.05);
  }

  .drop-btn{
    flex:1;
    border:none;
    padding: 12px 10px;
    font-weight: 900;
    cursor:pointer;
    background: transparent;
    color: var(--text);
    transition: background 0.12s ease;
  }

  .drop-btn:hover{
    background: rgba(47,179,92,0.14);
  }

  .drop-btn.test{
    border-left: 1px solid var(--outline);
  }

  /* ===== Danger Zone ===== */
  .danger-zone{
    position: fixed;
    right: 18px;
    bottom: 18px;
    display:flex;
    flex-direction:column;
    gap: 8px;
    z-index: 60;
    max-width: 260px;
  }

  #clearAllBtn{
    background: var(--danger);
    color: white;
    border:none;
    padding: 12px 14px;
    border-radius: 14px;
    font-weight: 900;
    cursor:pointer;
    box-shadow: 0 16px 32px rgba(0,0,0,0.3);
  }

  #clearAllBtn:hover{ opacity:0.9; }

  .danger-text{
    font-size: 0.78rem;
    opacity: 0.75;
    line-height:1.2;
    font-weight:600;
  }

  /* ===== Quiz Overlay ===== */
  .overlay{
    position: fixed;
    inset:0;
    background: var(--overlay);
    display:none;
    align-items:center;
    justify-content:center;
    padding: 16px;
    z-index: 999;
  }

  .quiz-shell{
    width: min(900px, 100%);
    height: min(92vh, 680px);
    background: var(--card);
    border-radius: 26px;
    box-shadow: 0 40px 90px rgba(0,0,0,0.55);
    border: 1px solid var(--outline);
    overflow:hidden;
    position:relative;
    display:flex;
    flex-direction:column;
  }

  /* Always visible X */
  .close-x{
    position:absolute;
    top: 12px;
    right: 12px;
    width: 42px;
    height: 42px;
    border-radius: 14px;
    border: 1px solid var(--outline);
    background: rgba(0,0,0,0.05);
    color: var(--text);
    font-size: 1.3rem;
    font-weight: 900;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    z-index: 10;
  }
  body.dark .close-x{
    background: rgba(255,255,255,0.06);
  }
  .close-x:hover{ transform: scale(1.02); }

  .quiz-top{
    padding: 18px 18px 14px;
    border-bottom: 1px solid var(--outline);
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap: 12px;
  }

  .quiz-top .left{
    display:flex;
    flex-direction:column;
    gap:6px;
    padding-right: 52px;
  }

  .quiz-title{
    font-weight: 950;
    font-size: 1.15rem;
    margin:0;
  }
  .quiz-sub{
    font-size: 0.85rem;
    opacity: 0.75;
    font-weight:600;
  }

  .quiz-body{
    flex:1;
    padding: 18px;
    overflow:auto;
  }

  /* Start screen bigger + nicer */
  .start-card{
    max-width: 720px;
    margin: 0 auto;
    padding: 26px;
    border-radius: 26px;
    border: 1px solid var(--outline);
    background: linear-gradient(135deg, rgba(47,179,92,0.16), transparent 55%);
    box-shadow: 0 18px 45px rgba(0,0,0,0.12);
  }

  .start-card h2{
    margin:0;
    font-size: 1.6rem;
    font-weight: 950;
  }

  .start-card p{
    margin: 10px 0 0;
    font-weight: 650;
    opacity: 0.75;
    line-height:1.35;
  }

  .start-actions{
    margin-top: 18px;
    display:flex;
    gap: 12px;
    flex-wrap:wrap;
  }

  .primary{
    background: var(--btn);
    color: var(--btnText);
    border:none;
    padding: 12px 16px;
    border-radius: 16px;
    font-weight: 950;
    cursor:pointer;
    box-shadow: 0 16px 30px rgba(0,0,0,0.18);
  }

  .ghost{
    background: transparent;
    border: 1px solid var(--outline);
    padding: 12px 16px;
    border-radius: 16px;
    font-weight: 900;
    cursor:pointer;
    color: var(--text);
  }

  /* Question + Answers */
  .qbox{
    max-width: 780px;
    margin: 0 auto;
    display:flex;
    flex-direction:column;
    gap: 14px;
  }

  .qmeta{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 12px;
    flex-wrap:wrap;
  }

  .pill{
    padding: 9px 12px;
    border-radius: 999px;
    border: 1px solid var(--outline);
    font-weight: 900;
    font-size: 0.85rem;
    background: rgba(0,0,0,0.03);
  }
  body.dark .pill{ background: rgba(255,255,255,0.05); }

  .flag-btn{
    border:none;
    cursor:pointer;
    padding: 9px 12px;
    border-radius: 999px;
    font-weight: 950;
    background: rgba(255,0,0,0.12);
    color: var(--text);
    border: 1px solid rgba(255,0,0,0.22);
  }

  .flag-btn.active{
    background: rgba(255,0,0,0.2);
    border-color: rgba(255,0,0,0.35);
  }

  .question{
    font-size: 1.15rem;
    font-weight: 950;
    line-height:1.25;
  }

  .answers{
    display:grid;
    grid-template-columns: 1fr;
    gap: 12px;
  }

  .ans{
    padding: 14px 14px;
    border-radius: 18px;
    border: 1px solid var(--outline);
    cursor:pointer;
    font-weight: 900;
    background: rgba(0,0,0,0.02);
    transition: transform 0.1s ease, background 0.12s ease, border-color 0.12s ease;
    color: var(--text);
  }
  body.dark .ans{
    background: rgba(255,255,255,0.04);
  }

  .ans:hover{
    transform: translateY(-1px);
    background: rgba(47,179,92,0.12);
  }

  /* FIX: selected answer visibility in dark mode */
  .ans.selected{
    background: rgba(47,179,92,0.28);
    border-color: rgba(47,179,92,0.55);
    outline: 2px solid rgba(47,179,92,0.35);
  }

  .quiz-bottom{
    padding: 14px 18px;
    border-top: 1px solid var(--outline);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 12px;
    flex-wrap:wrap;
  }

  .nav{
    display:flex;
    gap: 10px;
  }

  /* Review */
  .review-grid{
    display:grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 12px;
  }
  @media(max-width: 720px){
    .review-grid{ grid-template-columns: 1fr; }
  }

  .review-box{
    position:relative;
    padding: 14px;
    border-radius: 18px;
    border: 1px solid var(--outline);
    background: rgba(0,0,0,0.02);
  }
  body.dark .review-box{
    background: rgba(255,255,255,0.04);
  }

  .review-flag{
    position:absolute;
    top: 10px;
    right: 12px;
    font-size: 1rem;
    color: #ff3b3b;
    font-weight: 950;
  }

  .review-q{
    font-weight: 950;
    margin:0 0 8px;
    line-height:1.25;
  }
  .review-a{
    margin:0;
    font-weight: 700;
    opacity:0.85;
    line-height:1.25;
  }

  /* Score screen */
  .score-card{
    max-width: 720px;
    margin: 0 auto;
    padding: 26px;
    border-radius: 26px;
    border: 1px solid var(--outline);
    background: linear-gradient(135deg, rgba(47,179,92,0.18), transparent 55%);
    box-shadow: 0 18px 45px rgba(0,0,0,0.12);
    text-align:center;
  }
  .score-card h2{
    margin:0;
    font-size: 1.8rem;
    font-weight: 980;
  }
  .score-card .big{
    margin-top: 10px;
    font-size: 2.4rem;
    font-weight: 980;
  }
  .score-card .note{
    margin-top: 8px;
    opacity:0.75;
    font-weight:650;
  }

</style>
</head>

<body>

<!-- ===== TOPBAR ===== -->
<div class="topbar">
  <div class="topbar-inner">
    <div class="title">
      <h1>Money Mentor ‚Äì Student Dashboard</h1>
      <div class="sub">Study mode + Unit tests ‚Ä¢ Your best scores stay saved</div>
    </div>

    <div class="top-actions">
      <button id="backBtn" class="nav-btn back-btn">Back</button>
      <button id="videosBtn" class="nav-btn videos-btn">Videos</button>

      <!-- moved to LEFT of units box like you asked -->
      <button id="modeBtn" class="nav-btn mode-btn">üåô Dark</button>

      <div class="units-box" id="unitsBox">
        <span class="star">‚≠ê</span>
        <span id="unitsCompletedText">Units Completed: 0</span>
      </div>
    </div>
  </div>
</div>

<!-- ===== MAIN ===== -->
<div class="wrap">
  <div class="grid" id="unitGrid"></div>
</div>

<!-- ===== Danger Zone ===== -->
<div class="danger-zone">
  <button id="clearAllBtn">Clear All Data</button>
  <div class="danger-text">
    Warning: This permanently removes all saved scores, completed units, and progress.
  </div>
</div>

<!-- ===== QUIZ OVERLAY ===== -->
<div class="overlay" id="overlay">
  <div class="quiz-shell">

    <button class="close-x" id="closeX">‚úï</button>

    <div class="quiz-top">
      <div class="left">
        <div class="quiz-title" id="quizTitle">Unit</div>
        <div class="quiz-sub" id="quizSub">Study or take the test.</div>
      </div>
    </div>

    <div class="quiz-body" id="quizBody">

      <!-- Start screen -->
      <div class="start-card" id="startScreen">
        <h2 id="startTitle">Investing Vocab ‚Äì Unit</h2>
        <p id="startDesc">
          Choose study mode to practice, or unit test to record a score.
          Your dashboard saves your <b>highest score</b> permanently.
        </p>

        <div class="start-actions">
          <button class="primary" id="startStudyBtn">Study</button>
          <button class="ghost" id="startTestBtn">Unit Test</button>
          <button class="ghost" id="reviewBtn">Review Flagged</button>
        </div>
      </div>

      <!-- Quiz -->
      <div class="qbox" id="quizScreen" style="display:none;">
        <div class="qmeta">
          <div class="pill" id="qCount">Question 1 / 10</div>
          <button class="flag-btn" id="flagBtn">üö© Flag</button>
        </div>

        <div class="question" id="questionText">Question here</div>
        <div class="answers" id="answers"></div>
      </div>

      <!-- Review -->
      <div id="reviewScreen" style="display:none;">
        <div class="qbox">
          <div class="question">Flagged Review</div>
          <div class="review-grid" id="reviewGrid"></div>
        </div>
      </div>

      <!-- Score -->
      <div id="scoreScreen" style="display:none;">
        <div class="score-card">
          <h2>Unit Complete</h2>
          <div class="big" id="scoreBig">0%</div>
          <div class="note" id="scoreNote">Your best score will be saved.</div>
          <div style="margin-top:16px; display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
            <button class="primary" id="doneBtn">Done</button>
            <button class="ghost" id="retakeBtn">Retake</button>
          </div>
        </div>
      </div>

    </div>

    <div class="quiz-bottom" id="quizBottom" style="display:none;">
      <div class="nav">
        <button class="ghost" id="prevBtn">‚¨Ö Prev</button>
        <button class="ghost" id="nextBtn">Next ‚û°</button>
      </div>
      <button class="primary" id="finishBtn">Finish</button>
    </div>

  </div>
</div>

<script>
/* ============================================================
   DATA
   ============================================================ */

const UNITS = [
  {
    key: "unit1",
    name: "Unit 1 ‚Äì Investing Vocab",
    desc: "Stocks, bonds, ETFs, dividends, market basics.",
    quiz: [
      { q:"What is a stock?", a:["A loan to a company","Ownership in a company","A government tax","A savings account"], correct:1 },
      { q:"What is a dividend?", a:["A company‚Äôs profit paid to shareholders","A fee for buying stocks","A type of loan","A market crash"], correct:0 },
      { q:"What does ETF stand for?", a:["Equity Trade Fund","Exchange-Traded Fund","Electronic Transfer Form","Extra Tax Fee"], correct:1 },
      { q:"What is diversification?", a:["Buying only 1 stock","Spreading money across investments","Selling all investments","Only buying crypto"], correct:1 },
      { q:"What is a bond?", a:["Ownership in a company","A loan to a company/government","A type of stock split","A trading app"], correct:1 },
      { q:"What is a bull market?", a:["Market going up","Market going down","No trading allowed","Only bonds rising"], correct:0 },
      { q:"What is a bear market?", a:["Market going up","Market going down","Only ETFs exist","Dividends stop"], correct:1 },
      { q:"What is market cap?", a:["Company size based on stock value","A tax on trades","A type of bond","A trading limit"], correct:0 },
      { q:"What is a portfolio?", a:["A list of your investments","A bank statement","A tax form","A company‚Äôs profits"], correct:0 },
      { q:"What is a stock split?", a:["Stock disappears","Shares increase, price adjusts","Dividends stop","You lose ownership"], correct:1 },
    ]
  },
  {
    key: "unit2",
    name: "Unit 2 ‚Äì Risk & Returns",
    desc: "Volatility, long-term investing, compounding.",
    quiz: [
      { q:"What is volatility?", a:["Price movement up/down","Guaranteed profit","A dividend","A type of tax"], correct:0 },
      { q:"What is compound interest?", a:["Interest on interest over time","A fee for investing","A stock split","A market crash"], correct:0 },
      { q:"Higher risk usually means‚Ä¶", a:["Lower returns always","Higher potential returns","No returns","No volatility"], correct:1 },
      { q:"Time in the market beats‚Ä¶", a:["Timing the market","Buying ETFs","Dividends","Bonds"], correct:0 },
      { q:"What is an emergency fund for?", a:["Buying crypto","Unexpected expenses","Day trading","Paying dividends"], correct:1 },
      { q:"What is inflation?", a:["Prices rising over time","Stock market always up","Bonds guaranteed","Tax refunds"], correct:0 },
      { q:"What is a recession?", a:["Economy shrinking","Economy booming","Market always green","No unemployment"], correct:0 },
      { q:"What is a long-term strategy?", a:["Quick flips","Holding for years","Selling daily","Only cash"], correct:1 },
      { q:"What is a return?", a:["Money you lose","Profit or loss on investment","A tax bill","A dividend only"], correct:1 },
      { q:"What is risk tolerance?", a:["How much risk you can handle","How rich you are","Your taxes","A bond yield"], correct:0 },
    ]
  },
  {
    key: "unit3",
    name: "Unit 3 ‚Äì Trading Basics",
    desc: "Orders, stop-loss, limit, market, and strategy.",
    quiz: [
      { q:"What is a market order?", a:["Buys instantly at current price","Buys at a set price","Cancels automatically","Only for bonds"], correct:0 },
      { q:"What is a limit order?", a:["Buys/sells at a chosen price","Instant trade always","Stops losses automatically","A dividend order"], correct:0 },
      { q:"What is a stop-loss?", a:["An order to limit losses","A way to guarantee profit","A bond feature","A stock split"], correct:0 },
      { q:"Bid price is‚Ä¶", a:["What buyers offer","What sellers ask","Dividend amount","Tax rate"], correct:0 },
      { q:"Ask price is‚Ä¶", a:["What buyers offer","What sellers want","Market cap","Bond yield"], correct:1 },
      { q:"Spread is‚Ä¶", a:["Ask minus bid","Dividend minus tax","Price minus market cap","ETF minus stock"], correct:0 },
      { q:"Day trading is‚Ä¶", a:["Buying/selling same day","Holding for 10 years","Only bonds","Only ETFs"], correct:0 },
      { q:"What is liquidity?", a:["How easy it is to buy/sell","Company profit","A stock split","A dividend"], correct:0 },
      { q:"What is slippage?", a:["Getting a different price than expected","A stock split","A dividend increase","A tax refund"], correct:0 },
      { q:"Why use a plan?", a:["To reduce emotional trades","To guarantee profit","To avoid ETFs","To increase taxes"], correct:0 },
    ]
  }
];

/* ============================================================
   STORAGE + THEME
   ============================================================ */

const STORAGE = {
  scores: "unitScores",
  theme: "darkMode",
  themeSeen: "themeSeen"
};

function getScores(){
  return JSON.parse(localStorage.getItem(STORAGE.scores) || "{}");
}

function setScores(obj){
  localStorage.setItem(STORAGE.scores, JSON.stringify(obj));
}

function saveHighestScore(unitKey, newScore){
  const scores = getScores();
  const prev = scores[unitKey] ?? 0;
  if(newScore > prev){
    scores[unitKey] = newScore;
    setScores(scores);
  }
}

function getBestScore(unitKey){
  const scores = getScores();
  return scores[unitKey] ?? 0;
}

function isCompleted(unitKey){
  return getBestScore(unitKey) >= 80;
}

function initTheme(){
  const seen = localStorage.getItem(STORAGE.themeSeen);

  // If never viewed before -> start dark mode
  if(!seen){
    document.body.classList.add("dark");
    localStorage.setItem(STORAGE.theme, "dark");
    localStorage.setItem(STORAGE.themeSeen, "true");
    return;
  }

  // Otherwise load saved theme
  const saved = localStorage.getItem(STORAGE.theme) || "light";
  if(saved === "dark") document.body.classList.add("dark");
}

function setTheme(mode){
  if(mode === "dark"){
    document.body.classList.add("dark");
    localStorage.setItem(STORAGE.theme, "dark");
  }else{
    document.body.classList.remove("dark");
    localStorage.setItem(STORAGE.theme, "light");
  }
}

function updateModeButton(){
  const btn = document.getElementById("modeBtn");
  const isDark = document.body.classList.contains("dark");
  btn.textContent = isDark ? "‚òÄÔ∏è Light" : "üåô Dark";
}

/* ============================================================
   DASHBOARD RENDER
   ============================================================ */

function updateUnitsCompleted(){
  const completed = UNITS.filter(u => isCompleted(u.key)).length;
  document.getElementById("unitsCompletedText").textContent = `Units Completed: ${completed}`;
}

function renderDashboard(){
  const grid = document.getElementById("unitGrid");
  grid.innerHTML = "";

  UNITS.forEach(unit => {
    const best = getBestScore(unit.key);
    const completed = isCompleted(unit.key);

    const card = document.createElement("div");
    card.className = "unit-card";

    card.innerHTML = `
      <div class="unit-head">
        <div>
          <h3 class="unit-name">${unit.name}</h3>
          <p class="unit-desc">${unit.desc}</p>
        </div>
        <div class="badge">${completed ? "‚≠ê Completed" : "In Progress"}</div>
      </div>

      <div class="score-line">
        <div class="best">Best Score: <b>${best}%</b></div>
        <div>${completed ? "‚úî" : ""}</div>
      </div>

      <div class="progress">
        <div class="bar" style="width:${best}%;"></div>
      </div>

      <div class="dropdown">
        <button class="drop-btn study" data-unit="${unit.key}" data-mode="study">Study</button>
        <button class="drop-btn test" data-unit="${unit.key}" data-mode="test">Unit Test</button>
      </div>
    `;

    grid.appendChild(card);
  });

  // Attach events
  document.querySelectorAll(".drop-btn").forEach(btn => {
    btn.onclick = () => {
      const unitKey = btn.getAttribute("data-unit");
      const mode = btn.getAttribute("data-mode");
      openQuiz(unitKey, mode);
    };
  });

  updateUnitsCompleted();
}

/* ============================================================
   QUIZ ENGINE
   ============================================================ */

const overlay = document.getElementById("overlay");
const closeX = document.getElementById("closeX");

const quizTitle = document.getElementById("quizTitle");
const quizSub = document.getElementById("quizSub");

const startScreen = document.getElementById("startScreen");
const quizScreen = document.getElementById("quizScreen");
const reviewScreen = document.getElementById("reviewScreen");
const scoreScreen = document.getElementById("scoreScreen");

const startTitle = document.getElementById("startTitle");
const startDesc = document.getElementById("startDesc");

const startStudyBtn = document.getElementById("startStudyBtn");
const startTestBtn = document.getElementById("startTestBtn");
const reviewBtn = document.getElementById("reviewBtn");

const quizBottom = document.getElementById("quizBottom");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const finishBtn = document.getElementById("finishBtn");

const qCount = document.getElementById("qCount");
const flagBtn = document.getElementById("flagBtn");
const questionText = document.getElementById("questionText");
const answersDiv = document.getElementById("answers");

const reviewGrid = document.getElementById("reviewGrid");

const scoreBig = document.getElementById("scoreBig");
const scoreNote = document.getElementById("scoreNote");
const doneBtn = document.getElementById("doneBtn");
const retakeBtn = document.getElementById("retakeBtn");

let currentUnit = null;
let quizMode = "test"; // "study" or "test"
let quizData = [];
let currentIndex = 0;
let selectedAnswers = [];
let flagged = [];

// Shuffle helper
function shuffle(arr){
  const a = [...arr];
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function buildQuizData(unit){
  return unit.quiz.map(item => {
    const correctText = item.a[item.correct];
    const shuffledAnswers = shuffle(item.a);
    const newCorrectIndex = shuffledAnswers.indexOf(correctText);
    return {
      q: item.q,
      answers: shuffledAnswers,
      correctIndex: newCorrectIndex
    };
  });
}

function showOnly(screen){
  startScreen.style.display = "none";
  quizScreen.style.display = "none";
  reviewScreen.style.display = "none";
  scoreScreen.style.display = "none";

  screen.style.display = "block";
}

function openQuiz(unitKey, mode){
  currentUnit = UNITS.find(u => u.key === unitKey);
  quizMode = mode;

  quizData = buildQuizData(currentUnit);
  currentIndex = 0;
  selectedAnswers = Array(quizData.length).fill(null);
  flagged = Array(quizData.length).fill(false);

  overlay.style.display = "flex";
  document.body.style.overflow = "hidden";

  quizTitle.textContent = currentUnit.name;
  quizSub.textContent = (mode === "study")
    ? "Study mode (not scored). Practice as much as you want."
    : "Unit test (scored). Highest score is saved permanently.";

  // Start screen always first
  startTitle.textContent = currentUnit.name;
  startDesc.innerHTML =
    `Choose <b>Study</b> to practice, or <b>Unit Test</b> to save a score.
     Your dashboard keeps your <b>highest score</b> forever.`;

  quizBottom.style.display = "none";
  showOnly(startScreen);
}

function closeQuiz(){
  overlay.style.display = "none";
  document.body.style.overflow = "";
}

closeX.onclick = closeQuiz;

// Clicking outside shell closes
overlay.addEventListener("click", (e) => {
  if(e.target === overlay) closeQuiz();
});

function startQuiz(mode){
  quizMode = mode;
  showOnly(quizScreen);
  quizBottom.style.display = "flex";
  renderQuestion();
}

startStudyBtn.onclick = () => startQuiz("study");
startTestBtn.onclick = () => startQuiz("test");

reviewBtn.onclick = () => {
  showReview();
};

function renderQuestion(){
  const q = quizData[currentIndex];

  qCount.textContent = `Question ${currentIndex+1} / ${quizData.length}`;
  questionText.textContent = q.q;

  // Flag state
  flagBtn.classList.toggle("active", flagged[currentIndex] === true);
  flagBtn.textContent = flagged[currentIndex] ? "üö© Flagged" : "üö© Flag";

  answersDiv.innerHTML = "";

  q.answers.forEach((ansText, i) => {
    const btn = document.createElement("div");
    btn.className = "ans";
    btn.textContent = ansText;

    // Selected highlight (FIXED for dark mode)
    if(selectedAnswers[currentIndex] === i){
      btn.classList.add("selected");
    }

    btn.onclick = () => {
      selectedAnswers[currentIndex] = i;
      renderQuestion();
    };

    answersDiv.appendChild(btn);
  });

  prevBtn.disabled = currentIndex === 0;
  nextBtn.disabled = currentIndex === quizData.length - 1;
}

flagBtn.onclick = () => {
  flagged[currentIndex] = !flagged[currentIndex];
  renderQuestion();
};

prevBtn.onclick = () => {
  if(currentIndex > 0){
    currentIndex--;
    renderQuestion();
  }
};

nextBtn.onclick = () => {
  if(currentIndex < quizData.length - 1){
    currentIndex++;
    renderQuestion();
  }
};

finishBtn.onclick = () => {
  if(quizMode === "study"){
    showScore(null, true);
    return;
  }

  // Must answer all in test mode
  const missing = selectedAnswers.findIndex(a => a === null);
  if(missing !== -1){
    alert(`Answer all questions before finishing.\n\nMissing: Question ${missing+1}`);
    return;
  }

  // Score
  let correct = 0;
  quizData.forEach((q, idx) => {
    if(selectedAnswers[idx] === q.correctIndex) correct++;
  });

  const percent = Math.round((correct / quizData.length) * 100);

  // Save highest score only
  saveHighestScore(currentUnit.key, percent);

  // Update dashboard
  renderDashboard();

  showScore(percent, false);
};

function showScore(percent, isStudy){
  quizBottom.style.display = "none";
  showOnly(scoreScreen);

  if(isStudy){
    scoreBig.textContent = "Study Done";
    scoreNote.textContent = "Study mode does not save a score. Switch to Unit Test to record progress.";
    return;
  }

  const best = getBestScore(currentUnit.key);

  scoreBig.textContent = `${percent}%`;
  scoreNote.textContent = `Best Score Saved: ${best}% (highest score stays permanently).`;
}

doneBtn.onclick = () => {
  closeQuiz();
};

retakeBtn.onclick = () => {
  // restart same unit, same mode
  openQuiz(currentUnit.key, quizMode);
};

function showReview(){
  showOnly(reviewScreen);
  quizBottom.style.display = "none";

  reviewGrid.innerHTML = "";

  const flaggedIndexes = flagged
    .map((v, i) => v ? i : null)
    .filter(v => v !== null);

  if(flaggedIndexes.length === 0){
    reviewGrid.innerHTML = `
      <div class="review-box">
        <div class="review-q">No flagged questions</div>
        <div class="review-a">Flag questions during the quiz using üö© Flag.</div>
      </div>
    `;
    return;
  }

  flaggedIndexes.forEach(i => {
    const q = quizData[i];
    const chosenIndex = selectedAnswers[i];

    const chosenText = (chosenIndex === null)
      ? "(No answer selected)"
      : q.answers[chosenIndex];

    const correctText = q.answers[q.correctIndex];

    const box = document.createElement("div");
    box.className = "review-box";

    box.innerHTML = `
      <div class="review-flag">üö©</div>
      <p class="review-q">Q${i+1}: ${q.q}</p>
      <p class="review-a"><b>Your answer:</b> ${chosenText}</p>
      <p class="review-a"><b>Correct:</b> ${correctText}</p>
    `;

    reviewGrid.appendChild(box);
  });
}

/* ============================================================
   TOP BUTTONS + CLEAR DATA
   ============================================================ */

document.getElementById("backBtn").onclick = () => {
  window.location.href = "https://sites.google.com/view/money--mentor/home?authuser=0";
};

document.getElementById("videosBtn").onclick = () => {
  window.location.href = "https://sites.google.com/view/money--dash--mentor/learn/videos?authuser=0";
};

document.getElementById("modeBtn").onclick = () => {
  const isDark = document.body.classList.contains("dark");
  setTheme(isDark ? "light" : "dark");
  updateModeButton();
};

document.getElementById("clearAllBtn").onclick = () => {
  const c1 = confirm("Clear ALL data?\n\nThis will permanently delete your best scores and completed units.");
  if(!c1) return;

  const c2 = confirm("Last warning.\n\nPress OK to permanently delete everything.");
  if(!c2) return;

  localStorage.removeItem(STORAGE.scores);
  localStorage.removeItem(STORAGE.theme);
  localStorage.removeItem(STORAGE.themeSeen);

  location.reload();
};

/* ============================================================
   INIT
   ============================================================ */

initTheme();
updateModeButton();
renderDashboard();
</script>

</body>
</html>
