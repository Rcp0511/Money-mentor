<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Money Mentor | Learning Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
<style>
:root {
    --bg: #f0fdf4; 
    --dot-color: rgba(16, 185, 129, 0.6); 
    --card-bg: #ffffff;
    --dropdown-bg: #dcfce7;
    --text: #064e3b; 
    --text-light: #374151;
    --primary: #10b981;
    --primary-hover: #059669;
    --secondary: #1e293b;
    --accent: #d97706;
    --danger: #dc2626;
    --border: #86efac; 
    --card-line: rgba(16, 185, 129, 0.3);
    --test-btn-bg: #1e293b;
    --test-btn-border: transparent;
    --transition-speed: 0.4s;
    --ease-out-expo: cubic-bezier(0.19, 1, 0.22, 1);
    --ease-in-out-back: cubic-bezier(0.68, -0.6, 0.32, 1.6);
}

[data-theme="dark"] {
    --bg: #0f172a;
    --dot-color: rgba(16, 185, 129, 0.35); 
    --card-bg: #1e293b;
    --dropdown-bg: #1e293b;
    --text: #f1f5f9;
    --text-light: #94a3b8;
    --border: #334155;
    --card-line: rgba(255, 255, 255, 0.1);
    --test-btn-bg: #334155;
    --test-btn-border: #475569;
}

* { box-sizing: border-box; }

body, .unit-card, .btn, .unit-dropdown, .dot, .option-btn, .overlay {
    transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, transform 0.2s var(--ease-out-expo), box-shadow 0.2s ease;
}

body {
    margin: 0;
    font-family: 'Inter', sans-serif;
    background-color: var(--bg);
    background-image: 
        radial-gradient(var(--dot-color) 3px, transparent 3px),
        radial-gradient(var(--dot-color) 2px, transparent 2px),
        radial-gradient(var(--dot-color) 1.5px, transparent 1.5px);
    background-size: 140px 140px, 190px 190px, 250px 250px;
    background-position: 0 0, 40px 60px, 110px 180px;
    color: var(--text);
    overflow-x: hidden;
    min-height: 100vh;
    animation: backgroundFloat 60s linear infinite;
}

@keyframes backgroundFloat {
    0% { background-position: 0 0, 40px 60px, 110px 180px; }
    100% { background-position: 500px 500px, 440px 560px, 610px 680px; }
}

header {
    background: linear-gradient(135deg, #059669, #065f46);
    color: white;
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}

.logo {
    font-family: 'Poppins', sans-serif;
    font-weight: 800;
    font-size: 1.25rem;
    letter-spacing: -0.5px;
}

.header-tools { display: flex; align-items: center; gap: 0.75rem; }

.btn {
    border: none;
    border-radius: 12px;
    padding: 0.6rem 1.2rem;
    font-weight: 600;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    text-decoration: none;
    position: relative;
}

.btn:active { transform: scale(0.96); }
.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover { background: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
.btn-outline { background: rgba(255,255,255,0.05); color: white; border: 1px solid rgba(255,255,255,0.2); }
.btn-outline:hover { background: rgba(255,255,255,0.15); transform: translateY(-1px); }
.btn-ghost { background: transparent; color: var(--text); }
.header-tools .btn-ghost { color: white; }

.container { max-width: 1000px; margin: 2rem auto; padding: 0 1rem; }
.unit-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }

.unit-card {
    background: var(--card-bg);
    border-radius: 24px;
    border: 1px solid var(--border);
    overflow: hidden;
    box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);
    cursor: pointer;
    position: relative;
    backdrop-filter: blur(8px); 
}

.unit-card:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }

.unit-card::before {
    content: "";
    position: absolute;
    top: 0; left: 30px; bottom: 0;
    width: 2px;
    background: var(--card-line);
    z-index: 1;
}

.unit-card-hero {
    padding: 2.5rem;
    padding-left: 5rem;
    background: linear-gradient(135deg, #10b981 0%, #065f46 100%);
    color: white;
    position: relative;
    z-index: 2;
    overflow: hidden;
}

.unit-card.unit-2-blue .unit-card-hero {
    background: linear-gradient(135deg, #7dd3fc 0%, #0ea5e9 100%);
    color: #0c4a6e;
}

.unit-card-hero::after {
    content: "";
    position: absolute;
    top: 0; right: 0; bottom: 0; left: 0;
    background-image: repeating-linear-gradient(45deg, transparent, transparent 20px, rgba(255,255,255,0.08) 20px, rgba(255,255,255,0.08) 40px);
    pointer-events: none;
}

.unit-term-count {
    position: absolute;
    top: 1.5rem;
    right: 1.5rem;
    font-size: 0.75rem;
    font-weight: 800;
    background: rgba(0, 0, 0, 0.25);
    padding: 6px 12px;
    border-radius: 20px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    backdrop-filter: blur(4px);
    color: white;
}

.mastery-ribbon {
    position: absolute;
    top: -5px;
    left: 45px;
    font-size: 2.2rem;
    color: #fcd34d;
    filter: drop-shadow(0 4px 4px rgba(0,0,0,0.3));
    z-index: 10;
}

.unit-dropdown {
    max-height: 0;
    overflow: hidden;
    padding: 0 1.5rem 0 5rem;
    background: var(--dropdown-bg);
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    opacity: 0;
    transform: translateY(-10px);
    transition: all 0.5s var(--ease-out-expo);
}

.unit-dropdown.active { 
    max-height: 500px;
    padding: 1.5rem 1.5rem 1.5rem 5rem;
    opacity: 1;
    transform: translateY(0);
}

.overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: var(--bg);
    z-index: 1000;
    flex-direction: column;
}

.overlay-header {
    padding: 1rem 2rem;
    border-bottom: 2px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--card-bg);
}

.flashcard-stage { 
    perspective: 2000px; 
    height: 480px; 
    width: 95%;
    max-width: 800px; 
    margin: 1rem auto; 
    position: relative;
}
.flashcard {
    width: 100%; height: 100%; position: absolute;
    transition: transform 0.6s var(--ease-in-out-back), opacity 0.4s ease;
    transform-style: preserve-3d; cursor: pointer;
}
.flashcard.flipped { transform: rotateY(180deg); }

.card-face {
    position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 3.5rem; border-radius: 40px; border: 4px solid var(--primary);
    background: var(--card-bg); text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.15);
}
.card-back { transform: rotateY(180deg); background: var(--bg); border-style: dashed; }

.q-box { max-width: 750px; margin: 2rem auto; padding: 1.5rem; }
.options-list { display: flex; flex-direction: column; gap: 12px; margin: 1.5rem 0; }
.option-btn {
    background: var(--card-bg); border: 2px solid var(--border); padding: 1.2rem;
    border-radius: 16px; color: var(--text); font-weight: 600; text-align: left; cursor: pointer;
    font-size: 1rem;
}
.option-btn.selected { border-color: var(--primary); background: rgba(16, 185, 129, 0.1); }

.progress-container { width: 100%; height: 10px; background: var(--border); border-radius: 5px; overflow: hidden; margin: 1.5rem 0; }
.progress-bar { height: 100%; background: var(--primary); transition: width 0.3s ease; }

.action-trigger { font-size: 1.6rem; cursor: pointer; color: var(--text-light); }
.action-trigger.active { color: var(--accent); transform: scale(1.25); }

/* Chat Bot Styles */
.chat-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 2000;
    font-family: 'Inter', sans-serif;
}
.chat-bubble {
    width: 60px; height: 60px; border-radius: 50%;
    background: var(--primary); color: white;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    cursor: pointer; font-size: 1.5rem;
}
.chat-window {
    display: none; position: absolute; bottom: 80px; right: 0;
    width: 350px; height: 500px; background: var(--card-bg);
    border-radius: 20px; border: 1px solid var(--border);
    flex-direction: column; overflow: hidden;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
}
.chat-window.active { display: flex; }
.chat-header {
    padding: 1rem; background: var(--primary); color: white;
    display: flex; justify-content: space-between; align-items: center;
}
.chat-messages { flex: 1; padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
.message { padding: 10px 14px; border-radius: 15px; max-width: 80%; font-size: 0.9rem; line-height: 1.4; }
.bot-msg { background: var(--bg); color: var(--text); align-self: flex-start; border-bottom-left-radius: 2px; }
.user-msg { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
.chat-input-area { padding: 10px; border-top: 1px solid var(--border); display: flex; gap: 8px; }
.chat-input { flex: 1; border: 1px solid var(--border); border-radius: 10px; padding: 8px 12px; background: var(--bg); color: var(--text); outline: none; }
.dot-typing { display: flex; gap: 4px; padding: 10px; }
.dot-typing span { width: 6px; height: 6px; background: var(--text-light); border-radius: 50%; animation: blink 1s infinite alternate; }
.dot-typing span:nth-child(2) { animation-delay: 0.3s; }
.dot-typing span:nth-child(3) { animation-delay: 0.6s; }
@keyframes blink { from { opacity: 0.3; } to { opacity: 1; } }

@media (max-width: 768px) {
    .chat-window { width: calc(100vw - 40px); height: 400px; }
}
</style>
</head>
<body>

<header>
    <div class="header-tools">
        <a href="https://sites.google.com/view/money--mentor/home" class="btn btn-ghost" style="color:white"><i class="fas fa-chevron-left"></i> Home</a>
    </div>
    <div class="logo">MONEY MENTOR</div>
    <div class="header-tools">
        <button id="theme-btn" class="btn btn-outline" style="padding: 0.6rem;"><i class="fas fa-sun"></i></button>
        <div class="status-pill" style="color: white; border: 1px solid rgba(255,255,255,0.3); background: transparent;">
            Units Complete: <span id="unitsDone">0</span>/2
        </div>
    </div>
</header>

<div class="container">
    <div class="unit-grid" id="dashboard-grid"></div>
</div>

<div id="app-overlay" class="overlay">
    <div class="overlay-header">
        <button class="btn btn-ghost" onclick="closeOverlay()">
            <i class="fas fa-times"></i> Exit
        </button>
        <div id="overlay-title" style="font-weight: 700; color: var(--text)">Unit 1</div>
        <div id="action-btn-container">
            <i class="fas fa-star action-trigger" id="global-action-btn" onclick="handleAction()"></i>
        </div>
    </div>
    <div class="overlay-body" style="flex:1; overflow-y:auto; padding-bottom: 2rem;">
        <div class="content-max" id="overlay-content"></div>
    </div>
</div>

<!-- Chat Bot UI -->
<div class="chat-container">
    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <div style="font-weight: 700;"><i class="fas fa-robot"></i> Money Mentor AI</div>
            <i class="fas fa-times" style="cursor: pointer;" onclick="toggleChat()"></i>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message bot-msg">Hi! I'm your Money Mentor AI. Need help understanding a financial concept or term? Ask me anything!</div>
        </div>
        <div id="typingIndicator" style="display: none;">
            <div class="dot-typing"><span></span><span></span><span></span></div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" class="chat-input" placeholder="Ask about banking..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button class="btn btn-primary" style="padding: 6px 12px;" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
    <div class="chat-bubble" onclick="toggleChat()">
        <i class="fas fa-comment-dots"></i>
    </div>
</div>

<script>
const units = [
    {
        id: "unit1",
        title: "Basic Investing Vocab",
        icon: "fa-chart-line",
        class: "",
        data: [
            { 
                term: "Stock", 
                flashcardDef: "Think of this as owning a tiny slice of a company. When the company makes money or grows, your slice becomes more valuable.",
                q: "What is a 'stock'?", 
                a: ["Share of ownership in a company", "Debt issued by a company", "A bank savings account", "A type of corporate bond"], 
                c: 0 
            },
            { 
                term: "Bond", 
                flashcardDef: "This is essentially an IOU. You are acting as the bank and lending your money to a government or corporation in exchange for interest payments.",
                q: "What is a 'bond'?", 
                a: ["Share of ownership in a company", "Loan to a company or government", "An interest-bearing liquid account", "A type of insurance contract"], 
                c: 1 
            },
            { 
                term: "Asset", 
                flashcardDef: "Any item of value you own that could be converted into cash. This includes money in the bank, jewelry, or even a car.",
                q: "What is an 'asset'?", 
                a: ["Debt you owe to a bank", "Potential future salary income", "Something valuable you own", "An unavoidable expense item"], 
                c: 2 
            },
            { 
                term: "Liability", 
                flashcardDef: "The opposite of an asset. This is money that you owe to someone else, like a student loan, credit card debt, or a mortgage.",
                q: "What is a 'liability'?", 
                a: ["A company's total owned stock", "A shareholder dividend payment", "Debt or obligation you owe", "A financial resource of value"], 
                c: 2 
            },
            { 
                term: "Dividend", 
                flashcardDef: "A 'thank you' payment from a company to its shareholders. It's a way for a company to share its success directly with you.",
                q: "What is a 'dividend'?", 
                a: ["Company profits paid to shareholders", "Company profits kept for research", "Change in a stock's market price", "The interest paid on a corporate bond"], 
                c: 0 
            },
            { 
                term: "Capital", 
                flashcardDef: "The engine of your wealth. This is the specific pool of money you set aside to invest and grow, rather than spend on daily bills.",
                q: "What is 'capital'?", 
                a: ["Total company annual revenue", "Money used for investment", "The principal of a personal loan", "Total dividend earnings received"], 
                c: 1 
            },
            { 
                term: "Portfolio", 
                flashcardDef: "Your entire financial garden. It's the mix of different stocks, bonds, and other investments you hold at once.",
                q: "What is a 'portfolio'?", 
                a: ["A single high-performing stock holding", "A traditional bank savings account", "A summary of outstanding debts", "Collection of all your investments"], 
                c: 3 
            },
            { 
                term: "Risk", 
                flashcardDef: "The uncertainty of the future. In investing, it's the possibility that you might lose money or not make as much as you hoped.",
                q: "What is 'risk' in investing?", 
                a: ["The possibility of losing money", "A guaranteed investment return", "A fixed annual interest payment", "Steady company revenue growth"], 
                c: 0 
            },
            { 
                term: "Liquidity", 
                flashcardDef: "How fast you can get your cash back. Cash is the most liquid, while a house is very illiquid because it takes months to sell.",
                q: "What is 'liquidity'?", 
                a: ["The overall profitability of an investment", "Current market demand for specific stocks", "Ease of converting an asset to cash", "The long-term potential of an investment"], 
                c: 2 
            },
            { 
                term: "Interest", 
                flashcardDef: "The price of using someone else's money. You earn it when you save, and you pay it when you borrow.",
                q: "What is 'interest'?", 
                a: ["Profit made from selling a stock", "Payment for borrowing money", "The initial investment principal", "A specific dividend payout received"], 
                c: 1 
            }
        ]
    },
    {
        id: "unit2",
        title: "Banking & Payments",
        icon: "fa-piggy-bank",
        class: "unit-2-blue",
        data: [
            { term: "Credit Card", flashcardDef: "A card that grants you a 'line of credit.' You are spending the bank's money and must pay it back later, often with interest if you don't pay in full.", q: "What is a credit card?", a: ["Lets you borrow money now and pay later", "A card that requires you to pay the full amount immediately", "A card only for online payments", "A card that automatically transfers money for subscriptions"], c: 0 },
            { term: "Debit Card", flashcardDef: "Electronic access to your own checking account. Unlike a credit card, the money is taken out of your bank account almost instantly.", q: "How does a debit card work?", a: ["A card that stores points and rewards", "A card that tracks spending but cannot pay", "Charges your bank account immediately for purchases", "A card that lets you borrow money from the bank"], c: 2 },
            { term: "Digital Wallet", flashcardDef: "An app (like Apple Pay or Google Pay) that securely stores your card details on your phone so you can pay without a physical card.", q: "What does a digital wallet do?", a: ["Tracks purchases and automatically invests", "Stores payment information for mobile or online purchases", "Keeps all your money in one app but cannot pay", "Sends money to others without verifying identity"], c: 1 },
            { term: "PIN", flashcardDef: "Your 'Secret Handshake' with the ATM or card machine. It's a Personal Identification Number that keeps your account safe from unauthorized use.", q: "What is a PIN used for?", a: ["A personal number that secures access to your account", "A code that automatically earns rewards", "A number you enter once and never need again", "A number used only for logging in online"], c: 0 },
            { term: "Recurring Payment", flashcardDef: "A 'set it and forget it' payment. You give a company permission to charge your account automatically every month for things like Netflix or gym memberships.", q: "What is a recurring payment?", a: ["Payment you make manually every month", "A one-time payment for a subscription", "Automatic scheduled payment for a service", "A payment that cancels itself automatically"], c: 2 },
            { term: "Cashback", flashcardDef: "A reward program where the card issuer returns a small percentage (usually 1-5%) of what you spent back to you as a bonus.", q: "What is cashback?", a: ["Extra points that may expire", "A fee you pay for using a credit card", "Money returned to you after using a card", "Money automatically deducted from your account"], c: 2 },
            { term: "Overdraft", flashcardDef: "A financial 'accident' where you spend more money than you actually have in your bank account, causing a negative balance.", q: "What happens during an overdraft?", a: ["Spending more than your account balance, sometimes with fees", "Being temporarily locked out of your account", "Losing rewards points on your debit card", "Automatically depositing money from another account"], c: 0 },
            { term: "Financial Goal", flashcardDef: "A specific target you want to hit with your money, like saving $500 for a new phone or investing for college.", q: "What is a financial goal?", a: ["A rating of how much money you have", "Something you plan to achieve with money", "A list of items you want to buy online", "A target set by your bank without your input"], c: 1 },
            { term: "Emergency Fund", flashcardDef: "A 'rainy day' bucket of cash. It's money saved specifically for big, unexpected problems like a car breakdown or losing a job.", q: "What is an emergency fund?", a: ["Money borrowed from a friend", "Extra money for entertainment only", "Automatic savings deducted from each purchase", "Money set aside for unexpected expenses"], c: 3 },
            { term: "P2P Payment", flashcardDef: "Peer-to-Peer. Using apps like Venmo or CashApp to send money instantly to friends or family without needing cash or a check.", q: "What is a P2P payment?", a: ["Paying your bills automatically with a bank transfer", "Sending money directly to another person using an app", "Investing money in a stock account", "Sending money to a company for a subscription"], c: 1 },
            { term: "Subscription Service", flashcardDef: "A business model where you pay a flat fee on a regular schedule (weekly, monthly, or yearly) to keep access to a product.", q: "What is a subscription service?", a: ["Service you pay regularly for ongoing access", "A free trial that automatically ends", "A one-time purchase with no future access", "A service that tracks your spending without payment"], c: 0 },
            { term: "ATM Fee", flashcardDef: "The price you pay for the convenience of using a cash machine that doesn't belong to your own bank.", q: "What is an ATM fee?", a: ["A monthly fee for keeping your account", "Charge for using an ATM outside your bank‚Äôs network", "Money you earn for using certain machines", "A penalty for missing a payment"], c: 1 },
            { term: "Late Fee", flashcardDef: "A penalty charge applied to your account if you miss the deadline for a credit card or bill payment.", q: "What is a late fee?", a: ["Extra money charged for missing a payment", "A reward for paying on time", "Money saved automatically from your account", "A fee applied only to credit cards"], c: 0 },
            { term: "Financial Plan", flashcardDef: "Your roadmap for money. It details how you will earn, save, spend, and invest your funds to get what you want in life.", q: "What is a financial plan?", a: ["A document only your bank keeps for you", "A list of debts without solutions", "A method to track income, spending, and saving for goals", "A random estimate of how much to spend"], c: 2 },
            { term: "Prepaid Card", flashcardDef: "A card that isn't linked to a bank account. You load it with cash ahead of time and can only spend what is currently on the card.", q: "What is a prepaid card?", a: ["A card that borrows money from the bank", "Card loaded with a set amount of money that you can spend", "A card that only tracks rewards points", "A card linked to a checking account"], c: 1 }
        ]
    }
];

let currentUnit = null;
let activeStudySet = [];
let currentIdx = 0;
let userAnswers = [];
let markedQuestions = []; 
let isQuizMode = false;
let isAnimating = false;

let scores = JSON.parse(localStorage.getItem('mm_scores') || '{}');
let starredTerms = JSON.parse(localStorage.getItem('mm_starred') || '[]'); 

function renderDashboard() {
    const grid = document.getElementById('dashboard-grid');
    grid.innerHTML = '';
    let completedCount = 0;
    units.forEach(unit => {
        const highScore = scores[unit.id] || 0;
        const isMastered = highScore >= 90;
        if(isMastered) completedCount++;
        const card = document.createElement('div');
        card.className = `unit-card ${unit.class}`;
        card.onclick = () => toggleUnit(unit.id);
        card.innerHTML = `
            ${isMastered ? '<div class="mastery-ribbon"><i class="fas fa-medal"></i></div>' : ''}
            <div class="unit-card-hero">
                <div class="unit-term-count">${unit.data.length} Terms</div>
                <div class="unit-info">
                    <h2 style="margin:0; font-family:Poppins;"><i class="fas ${unit.icon}"></i> ${unit.title}</h2>
                    <p style="margin:10px 0 0; opacity:0.9; font-size:0.95rem; font-weight:600;">Best Score: ${highScore}%</p>
                </div>
            </div>
            <div class="unit-dropdown" id="drop-${unit.id}">
                <button class="btn btn-primary" onclick="openStudy('${unit.id}', event)" style="flex:1"><i class="fas fa-book-open"></i> Study</button>
                <button class="btn btn-primary" onclick="openQuiz('${unit.id}', event)" style="flex:1; background:var(--test-btn-bg);"><i class="fas fa-clipboard"></i> Test</button>
            </div>
        `;
        grid.appendChild(card);
    });
    document.getElementById('unitsDone').innerText = completedCount;
}

function toggleUnit(id) {
    const drops = document.querySelectorAll('.unit-dropdown');
    drops.forEach(d => d.id === `drop-${id}` ? d.classList.toggle('active') : d.classList.remove('active'));
}

function openStudy(unitId, event) {
    if(event) event.stopPropagation();
    currentUnit = units.find(u => u.id === unitId);
    activeStudySet = [...currentUnit.data];
    isQuizMode = false;
    currentIdx = 0;
    launchStudyUI();
}

function launchStudyUI() {
    document.getElementById('app-overlay').style.display = 'flex';
    document.getElementById('overlay-title').innerText = `${currentUnit.title} | Flashcards`;
    document.getElementById('action-btn-container').style.visibility = 'visible';
    const content = document.getElementById('overlay-content');
    content.innerHTML = `
        <div style="width:100%; margin: 0 auto; padding-top: 1rem;">
            <div style="text-align:center; color:var(--text); font-weight:700; margin-bottom:1rem;" id="card-counter">Card 1 of ${activeStudySet.length}</div>
            <div class="flashcard-stage" id="stage">
                <div class="flashcard" id="card-obj" onclick="this.classList.toggle('flipped')"></div>
            </div>
            <div style="max-width:800px; margin: 2rem auto 0; display:flex; justify-content:space-between; align-items:center;">
                <button class="btn btn-outline" style="color:var(--text); border-color:var(--border)" onclick="moveCard(-1)"><i class="fas fa-arrow-left"></i></button>
                <div class="status-pill">Tap to flip</div>
                <button class="btn btn-outline" style="color:var(--text); border-color:var(--border)" onclick="moveCard(1)"><i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
    `;
    updateFlashcardContent(document.getElementById('card-obj'), activeStudySet[currentIdx]);
}

function updateFlashcardContent(cardEl, data) {
    updateActionState();
    cardEl.innerHTML = `
        <div class="card-face">
            <div style="font-size: 2.5rem; font-weight: 800; color: var(--primary);">${data.term}</div>
        </div>
        <div class="card-face card-back">
            <div style="font-size: 1.5rem; font-weight: 500; line-height: 1.6; color: var(--text); padding: 0 1rem;">${data.flashcardDef}</div>
        </div>
    `;
}

function moveCard(step) {
    if(isAnimating) return;
    let nextIdx = currentIdx + step;
    if(nextIdx < 0 || nextIdx >= activeStudySet.length) return;
    isAnimating = true;
    const oldCard = document.getElementById('card-obj');
    const stage = document.getElementById('stage');
    const newCard = document.createElement('div');
    newCard.className = `flashcard ${step > 0 ? 'slide-in-right' : 'slide-in-left'}`;
    newCard.onclick = function() { this.classList.toggle('flipped'); };
    currentIdx = nextIdx;
    updateFlashcardContent(newCard, activeStudySet[currentIdx]);
    stage.appendChild(newCard);
    oldCard.classList.add(step > 0 ? 'slide-out-left' : 'slide-out-right');
    oldCard.id = ""; 
    document.getElementById('card-counter').innerText = `Card ${currentIdx + 1} of ${activeStudySet.length}`;
    setTimeout(() => { oldCard.remove(); newCard.id = 'card-obj'; isAnimating = false; }, 600);
}

function openQuiz(unitId, event) {
    event.stopPropagation();
    currentUnit = units.find(u => u.id === unitId);
    activeStudySet = [...currentUnit.data].sort(() => Math.random() - 0.5);
    userAnswers = new Array(activeStudySet.length).fill(null);
    markedQuestions = new Array(activeStudySet.length).fill(false);
    currentIdx = 0;
    isQuizMode = true;
    document.getElementById('app-overlay').style.display = 'flex';
    startQuiz();
}

function startQuiz() {
    document.getElementById('action-btn-container').style.visibility = 'visible';
    renderQuestion();
}

function renderQuestion() {
    const item = activeStudySet[currentIdx];
    const progress = ((currentIdx + 1) / activeStudySet.length) * 100;
    updateActionState();
    let optionsHtml = item.a.map((opt, i) => `<button class="option-btn ${userAnswers[currentIdx] === i ? 'selected' : ''}" onclick="selectOption(${i})">${opt}</button>`).join('');
    document.getElementById('overlay-content').innerHTML = `
        <div class="q-box">
            <span class="status-pill">Question ${currentIdx + 1} of ${activeStudySet.length}</span>
            <div class="progress-container"><div class="progress-bar" style="width:${progress}%"></div></div>
            <h2 style="margin: 1.5rem 0; font-size: 1.4rem; color:var(--text)">${item.q}</h2>
            <div class="options-list">${optionsHtml}</div>
            <div style="display:flex; justify-content:space-between; margin-top:2rem;">
                <button class="btn btn-outline" style="color:var(--text); border-color:var(--border)" onclick="prevQ()">Back</button>
                <button class="btn btn-primary" onclick="nextQ()">${currentIdx === activeStudySet.length - 1 ? 'Finish' : 'Next'}</button>
            </div>
        </div>
    `;
}

function selectOption(idx) { userAnswers[currentIdx] = idx; renderQuestion(); }
function nextQ() { if(currentIdx < activeStudySet.length - 1) { currentIdx++; renderQuestion(); } else { finishQuiz(); } }
function prevQ() { if(currentIdx > 0) { currentIdx--; renderQuestion(); } }

function finishQuiz() {
    let correct = activeStudySet.reduce((acc, item, i) => userAnswers[i] === item.c ? acc + 1 : acc, 0);
    const score = Math.round((correct / activeStudySet.length) * 100);
    if(!scores[currentUnit.id] || score > scores[currentUnit.id]) {
        scores[currentUnit.id] = score;
        localStorage.setItem('mm_scores', JSON.stringify(scores));
    }
    renderResults(score, correct);
}

function renderResults(score, correct) {
    document.getElementById('action-btn-container').style.visibility = 'hidden';
    document.getElementById('overlay-content').innerHTML = `
        <div class="q-box" style="text-align:center;">
            <div style="font-size: 4rem;">${score >= 90 ? 'üèÜ' : 'ü•à'}</div>
            <h1 style="color:var(--text)">${score}%</h1>
            <p style="color:var(--text-light); font-weight:700;">You got ${correct} out of ${activeStudySet.length} correct.</p>
            <button class="btn btn-primary" style="width:100%; margin-top:2rem;" onclick="closeOverlay()">Back to Dashboard</button>
        </div>
    `;
    renderDashboard();
}

function closeOverlay() { document.getElementById('app-overlay').style.display = 'none'; isQuizMode = false; }

function handleAction() {
    if(!isQuizMode) {
        const term = activeStudySet[currentIdx].term;
        if (starredTerms.includes(term)) starredTerms = starredTerms.filter(t => t !== term);
        else starredTerms.push(term);
        localStorage.setItem('mm_starred', JSON.stringify(starredTerms));
        updateActionState();
    }
}

function updateActionState() {
    const btn = document.getElementById('global-action-btn');
    if(!btn || !activeStudySet[currentIdx]) return;
    if(isQuizMode) btn.style.display = 'none';
    else {
        btn.style.display = 'block';
        const term = activeStudySet[currentIdx].term;
        btn.className = starredTerms.includes(term) ? "fas fa-star action-trigger active" : "fas fa-star action-trigger";
    }
}

// --- Chat Bot Logic ---
const apiKey = ""; 

async function sendMessage() {
    const input = document.getElementById('chatInput');
    const msg = input.value.trim();
    if(!msg) return;

    appendMessage(msg, 'user');
    input.value = '';
    
    const indicator = document.getElementById('typingIndicator');
    indicator.style.display = 'block';
    
    const systemPrompt = "You are Money Mentor AI, a friendly and helpful tutor for students under 18 learning financial literacy and banking. Your goal is to explain concepts like stocks, bonds, credit cards, and interest in simple, easy-to-understand terms. Keep responses clean, safe, and encouraging. Be concise.";
    
    const callApi = async (retryCount = 0) => {
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: msg }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] }
                })
            });
            
            if (!response.ok) throw new Error('API Error');
            
            const data = await response.json();
            const botText = data.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (botText) {
                indicator.style.display = 'none';
                appendMessage(botText, 'bot');
            } else {
                throw new Error('Empty response');
            }
        } catch (e) {
            if (retryCount < 5) {
                const delay = Math.pow(2, retryCount) * 1000;
                setTimeout(() => callApi(retryCount + 1), delay);
            } else {
                indicator.style.display = 'none';
                appendMessage("I'm having trouble connecting right now. Please try again in a moment!", 'bot');
            }
        }
    };

    callApi();
}

function appendMessage(text, role) {
    const chatMessages = document.getElementById('chatMessages');
    const div = document.createElement('div');
    div.className = `message ${role}-msg`;
    div.innerText = text;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function toggleChat() {
    document.getElementById('chatWindow').classList.toggle('active');
}

document.getElementById('theme-btn').onclick = () => {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
    document.getElementById('theme-btn').innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
};

window.onload = renderDashboard;
</script>
</body>
</html>
