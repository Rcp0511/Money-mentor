// ------------------ Quiz Setup ------------------
let quizData=[], answers=[], flags=[], current=0;

// Use the original data and shuffle answers for each question
function openQuiz(){
  quizOverlay.style.display='flex';
  startScreen.style.display='block'; quiz.style.display='none'; reviewDiv.style.display='none'; scoreScreen.style.display='none';
  flagBtn.style.display='none';
  quizData=quizDataOriginal.map(q=>({...q, shuffledAnswers: shuffleArray([...q.a])}));
  answers=Array(quizData.length).fill(null);
  flags=Array(quizData.length).fill(false);
  current=0;
}

// ------------------ Load Question ------------------
function loadQuestion(){
  const q=quizData[current];
  questionNumberEl.textContent=`Question ${current+1} of ${quizData.length}`;
  questionEl.textContent=q.q;
  optionsEl.innerHTML='';
  
  q.shuffledAnswers.forEach((opt,i)=>{
    const btn=document.createElement('button'); 
    btn.textContent=opt;
    if(answers[current]===i) btn.classList.add('selected');
    btn.onclick=()=>{
      answers[current]=i;
      Array.from(optionsEl.children).forEach(b=>b.classList.remove('selected'));
      btn.classList.add('selected');
    };
    optionsEl.appendChild(btn);
  });

  // Flag button red if flagged
  flagBtn.innerHTML=flags[current]?'<i class="fas fa-flag"></i>':'<i class="far fa-flag"></i>';
  progressEl.style.width=`${((current+1)/quizData.length)*100}%`;
  nextBtn.textContent=(current===quizData.length-1)?'Review':'Next';
}

// ------------------ Navigation ------------------
nextBtn.onclick=()=>{
  if(current===quizData.length-1){ showReview(); }
  else{ current++; loadQuestion(); }
};
prevBtn.onclick=()=>{
  if(current>0){ current--; loadQuestion(); }
};
flagBtn.onclick=()=>{
  flags[current]=!flags[current];
  loadQuestion();
};

// ------------------ Review Screen ------------------
function showReview(){
  quiz.style.display='none'; reviewDiv.style.display='block'; reviewGrid.innerHTML='';
  quizData.forEach((q,i)=>{
    const box=document.createElement('div'); 
    box.className='review-box';
    // Background: answered=green, not answered=red
    let bgColor = answers[i]!==null ? 'green' : 'red';
    // If flagged: keep flag and adjust color based on answered
    if(flags[i]){
      const flagIcon=document.createElement('i');
      flagIcon.className='fas fa-flag';
      flagIcon.style.position='absolute';
      flagIcon.style.top='5px';
      flagIcon.style.right='5px';
      flagIcon.style.color='red';
      box.appendChild(flagIcon);
      bgColor = answers[i]!==null ? 'green' : 'red';
    }
    box.style.backgroundColor = bgColor;
    box.textContent=`Q${i+1}`;
    box.onclick=()=>{ reviewDiv.style.display='none'; quiz.style.display='block'; current=i; loadQuestion(); };
    reviewGrid.appendChild(box);
  });
}

// ------------------ Score Calculation ------------------
toScoreBtn.onclick=calculateScore;
function calculateScore(){
  reviewDiv.style.display='none'; scoreScreen.style.display='block'; missedList.innerHTML='';
  let score=0;
  quizData.forEach((q,i)=>{
    const correctText=q.a[q.correct];
    const userAnswer=answers[i]!==null?q.shuffledAnswers[answers[i]]:null;
    if(userAnswer===correctText) score++;
    const li=document.createElement('li');
    li.innerHTML=`Q${i+1}: Your answer: ${userAnswer||'None'}<br>Correct: ${correctText}<br>Explanation: ${q.explanation}`;
    li.innerHTML = `${userAnswer===correctText?'✅':'❌'} ${li.innerHTML}`;
    li.classList.add(userAnswer===correctText?'correct-score':'wrong-score');
    missedList.appendChild(li);
  });
  const percent=Math.round((score/quizData.length)*100);
  lastScoreText.textContent=`Last Unit Test Score: ${percent}%`;
  let highScore=localStorage.getItem('unit1HighScore')||0;
  highScore=Math.max(highScore,percent); 
  localStorage.setItem('unit1HighScore',highScore);
  highScoreText.textContent=`Highest Unit Test Score: ${highScore}%`;
  updateUnitCardScore(percent,highScore);
}

// ------------------ Utility Functions ------------------
function shuffleArray(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a;}

function updateUnitCardScore(last,high){
  const cardScores=container.children[0].querySelector('.scores');
  cardScores.textContent=`Last Unit Test Score: ${last}% | Highest Unit Test Score: ${high}%`;
}

// ------------------ Button Handlers ------------------
closeQuiz.onclick=()=>{quizOverlay.style.display='none';};
startBtn.onclick=()=>{startScreen.style.display='none'; quiz.style.display='block'; flagBtn.style.display='block'; loadQuestion();};
restartBtn.onclick=openQuiz;
